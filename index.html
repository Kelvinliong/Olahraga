<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Olahraga SJKC KEE TEE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .achieved { background-color: #dcfce7 !important; border: 2px solid #22c55e !important; color: #15803d !important; font-weight: bold; }
        .pending { background-color: #fef2f2 !important; border: 1px solid #fca5a5 !important; }
        .btn-hadir { background-color: #10b981 !important; color: white !important; font-weight: 900; }
        header { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .header-shrink { padding-top: 0.4rem !important; padding-bottom: 0.4rem !important; }
        .header-shrink h1 { font-size: 1.1rem !important; }
        .header-shrink #subTitle, .header-shrink #syncStatus { display: none; }
        .progress-bar { height: 6px; border-radius: 3px; background: #e2e8f0; overflow: hidden; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.5s ease; }
        .tab-btn.active { border-bottom: 4px solid #f59e0b; color: #f59e0b; font-weight: 900; }
        input[type="number"] { font-size: 16px !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col w-full overflow-x-hidden text-slate-900">

<header id="mainHeader" class="bg-indigo-950 text-white p-4 md:p-6 sticky top-0 z-50 shadow-xl w-full border-b-4 border-yellow-500">
    <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-center gap-2 md:gap-6">
        <div class="text-center md:text-left">
            <div class="flex items-center justify-center md:justify-start gap-2">
                <h1 class="text-xl md:text-3xl font-black tracking-tight text-yellow-400">ÂêØÊô∫Â≠¶Ê†°Áî∞ÂæÑËÆ∞ÂΩï</h1>
                <div id="syncStatus" class="flex items-center gap-1 bg-white/10 px-2 py-0.5 rounded text-[9px] font-bold">
                    <span id="syncDot" class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span id="syncText">Cloud Ready</span>
                </div>
            </div>
            <p id="subTitle" class="text-[9px] font-bold opacity-60 uppercase tracking-widest hidden md:block">SJKC KEE TEE SPORTS SYSTEM</p>
        </div>
        <div id="btnGroup" class="flex flex-wrap justify-center gap-2 mt-2 md:mt-0">
            <button onclick="showDistribution()" class="bg-blue-600 text-white px-3 py-2 rounded-xl text-[10px] font-black">üìã PENGAGIHAN</button>
            <button onclick="toggleDashboard()" class="bg-yellow-500 text-indigo-950 px-3 py-2 rounded-xl text-[10px] font-black">üìä DATA</button>
            <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-3 py-2 rounded-xl text-[10px] font-black">üì• EXCEL</button>
        </div>
    </div>
    <div class="max-w-[1600px] mx-auto mt-3">
        <select id="sessionSelector" onchange="syncSession()" class="w-full bg-indigo-900 border border-indigo-700 rounded-xl p-3 text-xs text-white font-bold outline-none shadow-inner"></select>
    </div>
</header>

<main class="flex-1 w-full max-w-[1600px] mx-auto p-4">
    <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4"></div>
</main>

<div id="dashboardModal" class="fixed inset-0 bg-slate-900/95 z-[300] hidden backdrop-blur-xl p-2 md:p-4 overflow-y-auto">
    <div class="bg-white rounded-[2rem] md:rounded-[3rem] w-full max-w-7xl mx-auto shadow-2xl overflow-hidden min-h-[90vh]">
        <div class="flex border-b bg-slate-50 px-6 pt-6 gap-6 sticky top-0 z-10">
            <button onclick="switchTab('attendance')" id="tab-att" class="tab-btn active pb-4 text-[10px] md:text-xs font-black uppercase text-slate-400">Kehadiran</button>
            <button onclick="switchTab('performance')" id="tab-perf" class="tab-btn pb-4 text-[10px] md:text-xs font-black uppercase text-slate-400">Prestasi</button>
            <button onclick="toggleDashboard()" class="ml-auto text-slate-400 hover:text-red-500 font-bold text-2xl mb-4">&times;</button>
        </div>
        <div id="dashboardContent" class="p-4 md:p-8"></div>
    </div>
</div>

<div id="distModal" class="fixed inset-0 bg-slate-900/90 z-[200] hidden backdrop-blur-md flex items-center justify-center p-2">
    <div class="bg-white rounded-[2rem] w-full max-w-5xl shadow-2xl overflow-hidden max-h-[95vh] flex flex-col">
        <div class="p-5 bg-blue-600 text-white flex justify-between items-center font-black uppercase text-xs tracking-widest">
            <span>Senarai Pengagihan</span><button onclick="closeDist()" class="text-2xl">&times;</button>
        </div>
        <div id="distContent" class="p-4 md:p-8 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50"></div>
    </div>
</div>

<script>
// ==================== 1. ÈÖçÁΩÆ‰∫ëÁ´Ø URL ====================
const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbw2UHJYkxgWk01M6P3GDjlZjH3cvc6vuTeS_lntdUxWun3kdYEbAV3D8yrLVJ2hU99l/exec'; 

// ==================== 2. Âü∫Á°ÄÊï∞ÊçÆ (Â∑≤Âä†ÂÖ•ÂàùÂßã Best ÊàêÁª©) ====================
const ACARA_LABELS = { run: "LUMBA LARI", high: "LOMPAT TINGGI", long: "LOMPAT JAUH", shot: "LONTAR PELURU" };
const SCHEDULE = [
    { d: "24/2/26 Selasa", m: "2-4pm", a: ["high", "long"] },
    { d: "25/2/26 Rabu", m: "2-4pm", a: ["run", "shot"] },
    { d: "26/2/26 Khamis", m: "2-4pm", a: ["high", "long"] },
    { d: "2/3/26 Isnin", m: "2-4pm", a: ["run", "shot"] },
    { d: "4/3/26 Rabu", m: "4-5pm", a: ["run", "shot"] },
    { d: "5/3/26 Khamis", m: "4-5pm", a: ["high", "long"] },
    { d: "9/3/26 Isnin", m: "2-4pm", a: ["run", "shot"] },
    { d: "10/3/26 Selasa", m: "2-4pm", a: ["high", "long"] },
    { d: "11/3/26 Rabu", m: "4-5pm", a: ["run", "shot"], n: "üèÜ PEMILIHAN AKHIR" },
    { d: "12/3/26 Khamis", m: "4-5pm", a: ["high", "long"], n: "üèÜ PEMILIHAN AKHIR" },
    { d: "16/3/26 Isnin", m: "2-4pm", a: ["run", "shot"] },
    { d: "17/3/26 Selasa", m: "2-4pm", a: ["high", "long"] },
    { d: "30/3/26 Isnin", m: "2-4pm", a: ["run", "shot"] },
    { d: "31/3/26 Selasa", m: "2-4pm", a: ["high", "long", "shot"] },
    { d: "1/4/26 Rabu", m: "2-4pm", a: ["high", "long", "shot"] }
];

// ÂàùÂßãÂåñÂêçÂçïÔºåÂåÖÂê´ÊÇ®Êèê‰æõÁöÑÂõæÁâá‰∏≠ÁöÑ Best Êï∞ÊçÆ
const STUDENTS = [
    { n: "AIDEN LEE JUN YING", t: "TAHUN 6", events: ["long"], initBest: { long: 3.30 } },
    { n: "ANGELLYNE TIJAN LAH", t: "TAHUN 6", events: ["run", "high"], initBest: { run: 24, high: 0.95 } },
    { n: "AURELIUS PHILEMON WAN AUGUST", t: "TAHUN 6", events: ["high", "long", "shot"], initBest: { high: 1.0, long: 3.50, shot: 7.03 } },
    { n: "AYDEN JOSEPH SUSILAN SADASIVAN", t: "TAHUN 6", events: ["high", "long"], initBest: { high: 1.05, long: 3.50 } },
    { n: "FANILY TIONG HUNG KIEW", t: "TAHUN 6", events: ["high"], initBest: { high: 1.0 } },
    { n: "LIEW JIA XUAN", t: "TAHUN 6", events: ["long"], initBest: { long: 3.35 } },
    { n: "MARK ARTHUR SAMSON", t: "TAHUN 6", events: ["high"], initBest: { high: 1.0 } },
    { n: "NGAN MEI TING", t: "TAHUN 6", events: ["run", "high", "long"], initBest: { run: 26, high: 1.0, long: 2.80 } },
    { n: "SUZANNE CHUPPU AK JUA", t: "TAHUN 6", events: ["long"], initBest: { long: 3.28 } },
    { n: "GOH WEN WEN", t: "TAHUN 5", events: ["run"], initBest: { run: 26 } },
    { n: "GWENDOLYNE ANNASTASHA", t: "TAHUN 5", events: ["run", "high", "long"], initBest: { run: 24, high: 1.0, long: 2.60 } },
    { n: "OLWENTYO SIM XIAO PING", t: "TAHUN 5", events: ["long"], initBest: { long: 2.84 } },
    { n: "RACHEL BOON CHAI", t: "TAHUN 5", events: ["run", "high", "long"], initBest: { run: 26, high: 1.0, long: 1.59 } },
    { n: "ADAM MIKHAIL SAMSON", t: "TAHUN 4", events: ["shot"], initBest: { shot: 6.20 } },
    { n: "ANTHONY AJANG LAH", t: "TAHUN 4", events: ["run", "long"], initBest: { run: 25, long: 2.70 } },
    { n: "CADENCE BULAN OLYMPIA", t: "TAHUN 4", events: ["run", "high", "long"], initBest: { run: 28, high: 0.9, long: 1.95 } },
    { n: "CASSIE SIM CHEN SHIEN", t: "TAHUN 4", events: ["run", "long"], initBest: { run: 27, long: 1.65 } },
    { n: "GRAYSON ANAK ELIAM", t: "TAHUN 4", events: ["shot"], initBest: { shot: 4.30 } },
    { n: "TIARA EMILEESYHA BINTI ABDULLAH", t: "TAHUN 4", events: ["run"], initBest: { run: 28 } },
    { n: "ADY LYTHU JIFLI", t: "TAHUN 3", events: ["high"], initBest: { high: 1.05 } },
    { n: "GOH KEE JUN", t: "TAHUN 3", events: ["high"], initBest: { high: 0.95 } },
    { n: "SCARLETT JACKSON CASSIDY", t: "TAHUN 3", events: ["long"], initBest: { long: 1.50 } },
    { n: "YUVENIA CHUMANG", t: "TAHUN 3", events: ["shot"], initBest: { shot: 4.00 } }
];

const GOALS = { "TAHUN 6": { run: 23, high: 1.20, long: 3.80, shot: 8.65 }, "TAHUN 5": { run: 23, high: 1.18, long: 3.60, shot: 7.00 }, "TAHUN 4": { run: 24, high: 1.12, long: 3.50, shot: 5.50 }, "TAHUN 3": { run: 24, high: 1.12, long: 3.50, shot: 5.50 } };

let records = JSON.parse(localStorage.getItem('keetee_sports_v2')) || {};
let currentTab = 'attendance';
let saveTimer;

// Â¶ÇÊûú records ÊòØÁ©∫ÁöÑÔºåÂàô‰ΩøÁî® initBest ÂàùÂßãÂåñËÆ∞ÂΩï
STUDENTS.forEach(s => {
    if (!records[s.n]) {
        records[s.n] = { daily: {}, best: s.initBest || {} };
    } else if (!records[s.n].best || Object.keys(records[s.n].best).length === 0) {
        records[s.n].best = s.initBest || {};
    }
});

window.onscroll = function() {
    const header = document.getElementById("mainHeader");
    if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
        header.classList.add("header-shrink");
    } else {
        header.classList.remove("header-shrink");
    }
};

async function loadCloudData() {
    updateSyncUI('loading');
    try {
        const response = await fetch(CLOUD_URL);
        const cloudData = await response.json();
        if (Object.keys(cloudData).length > 0) {
            records = cloudData;
            localStorage.setItem('keetee_sports_v2', JSON.stringify(records));
            renderList();
            updateSyncUI('success');
        }
    } catch (e) { updateSyncUI('error'); }
}

async function saveToCloud() {
    updateSyncUI('saving');
    localStorage.setItem('keetee_sports_v2', JSON.stringify(records));
    try {
        await fetch(CLOUD_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(records)
        });
        updateSyncUI('success');
    } catch (e) { updateSyncUI('error'); }
}

function updateSyncUI(status) {
    const dot = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    if (status === 'saving_local') {
        dot.className = "w-2 h-2 rounded-full bg-blue-400";
        text.innerText = "Typing...";
    } else if (status === 'loading' || status === 'saving') {
        dot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
        text.innerText = "Syncing...";
    } else if (status === 'success') {
        dot.className = "w-2 h-2 rounded-full bg-green-500";
        text.innerText = "Cloud Synced";
    } else {
        dot.className = "w-2 h-2 rounded-full bg-red-500";
        text.innerText = "Offline";
    }
}

function init() {
    const sel = document.getElementById('sessionSelector');
    SCHEDULE.forEach((s, i) => {
        let opt = document.createElement('option');
        opt.value = i; opt.innerText = `${s.d} (${s.m})`;
        sel.appendChild(opt);
    });
    renderList();
    loadCloudData();
}

function syncSession() { renderList(); window.scrollTo({top: 0, behavior: 'smooth'}); }

function renderList() {
    const s = SCHEDULE[document.getElementById('sessionSelector').value];
    const container = document.getElementById('studentList');
    container.innerHTML = '';
    const list = STUDENTS.filter(std => std.events.some(e => s.a.includes(e)));
    list.forEach(std => {
        const isHadir = records[std.n].daily[s.d]?.attend || false;
        const card = document.createElement('div');
        card.className = "bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200";
        let inputs = '';
        s.a.filter(ev => std.events.includes(ev)).forEach(ev => {
            const val = records[std.n].daily[s.d]?.[ev] || "";
            const target = (GOALS[std.t] || GOALS["TAHUN 4"])[ev];
            const ok = val !== "" && (ev === 'run' ? val <= target : val >= target);
            inputs += `<div class="mt-3"><p class="text-[9px] font-black text-slate-400 uppercase">${ACARA_LABELS[ev]}</p>
                <input type="number" step="0.01" inputmode="decimal" value="${val}" 
                oninput="updateData('${std.n}','${s.d}','${ev}',this.value, event)" 
                class="w-full rounded-xl p-3 text-sm font-black outline-none border transition-all ${val===''?'bg-slate-50':(ok?'achieved':'pending')}" placeholder="0.00"></div>`;
        });
        card.innerHTML = `<div class="flex justify-between items-start border-b pb-3"><div><h3 class="font-black text-slate-900 text-[13px] uppercase leading-tight">${std.n}</h3><p class="text-[8px] text-indigo-500 font-bold mt-1">${std.t}</p></div>
            <button onclick="markAttend('${std.n}','${s.d}')" class="text-[8px] border px-3 py-2 rounded-lg font-black uppercase ${isHadir?'btn-hadir':'bg-white text-slate-400'}">${isHadir?'Hadir':'Tidak'}</button></div><div>${inputs}</div>`;
        container.appendChild(card);
    });
}

function updateData(n, d, ev, v, event) {
    if (v.endsWith('.')) return; 
    const numValue = v === "" ? "" : parseFloat(v);
    if(!records[n].daily[d]) records[n].daily[d] = { attend: true };
    records[n].daily[d][ev] = numValue;
    
    // ËÆ°ÁÆóÊñ∞ÁöÑ Best
    let dayValues = Object.values(records[n].daily).map(day => day[ev]).filter(val => val !== undefined && val !== "" && !isNaN(val));
    let initialBest = STUDENTS.find(s => s.n === n).initBest[ev];
    if (initialBest !== undefined) dayValues.push(initialBest);
    
    if(dayValues.length > 0) records[n].best[ev] = (ev === 'run' ? Math.min(...dayValues) : Math.max(...dayValues));
    
    const inputField = event.target;
    const target = (GOALS[STUDENTS.find(s=>s.n===n).t] || GOALS["TAHUN 4"])[ev];
    const ok = numValue !== "" && (ev === 'run' ? numValue <= target : numValue >= target);
    inputField.classList.remove('achieved', 'pending', 'bg-slate-50');
    inputField.classList.add(numValue === '' ? 'bg-slate-50' : (ok ? 'achieved' : 'pending'));
    clearTimeout(saveTimer);
    updateSyncUI('saving_local');
    saveTimer = setTimeout(saveToCloud, 3000); 
}

function markAttend(n, d) {
    if(!records[n].daily[d]) records[n].daily[d] = { attend: false };
    records[n].daily[d].attend = !records[n].daily[d].attend;
    saveToCloud(); renderList();
}

function toggleDashboard() {
    const m = document.getElementById('dashboardModal');
    m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) refreshDashboard();
}

function switchTab(t) { 
    currentTab = t; 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(t === 'attendance' ? 'tab-att' : 'tab-perf').classList.add('active');
    refreshDashboard(); 
}

function refreshDashboard() {
    const content = document.getElementById('dashboardContent');
    if (currentTab === 'attendance') {
        let rows = STUDENTS.map(s => {
            let cells = SCHEDULE.map(day => {
                if(!day.a.some(a => s.events.includes(a))) return `<td class="p-2 text-center text-slate-200">-</td>`;
                return `<td class="p-2 text-center border-x">${records[s.n]?.daily?.[day.d]?.attend ? '‚úÖ' : '‚ùå'}</td>`;
            }).join('');
            return `<tr class="border-b text-[10px]"><td class="p-3 font-black uppercase sticky left-0 bg-white shadow-sm z-10">${s.n}</td>${cells}</tr>`;
        }).join('');
        content.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-slate-100 text-[8px] uppercase tracking-tighter"><th class="p-3 sticky left-0 bg-slate-100 z-20">Nama</th>${SCHEDULE.map(d=>`<th class="p-1 text-center border-x">${d.d.split(' ')[0]}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table></div>`;
    } else {
        let rows = STUDENTS.map(s => {
            let perfs = s.events.map(ev => {
                const b = records[s.n]?.best?.[ev] || 0, g = (GOALS[s.t] || GOALS["TAHUN 4"])[ev], ok = b>0 && (ev==='run'?b<=g:b>=g);
                const unit = ev === 'run' ? 's' : 'm';
                return `<div class="mb-3 bg-slate-50 p-3 rounded-xl border"><div class="flex justify-between text-[9px] font-black uppercase"><span>${ACARA_LABELS[ev]}</span><span class="${ok?'text-green-600':'text-red-500'}">Gap: ${b>0?(b-g).toFixed(2)+unit:'--'}</span></div><div class="progress-bar mt-1"><div class="progress-fill" style="width: ${b>0?(ev==='run'?Math.min(100,(g/b)*100):Math.min(100,(b/g)*100)):0}%"></div></div><div class="flex justify-between text-[8px] mt-1 opacity-50 font-bold"><span>BEST: ${b?b+unit:'--'}</span><span>GOAL: ${g+unit}</span></div></div>`;
            }).join('');
            return `<tr class="border-b"><td class="p-3 font-black text-xs w-1/3">${s.n}<p class="text-[8px] text-blue-500 font-normal">${s.t}</p></td><td class="p-3 w-2/3">${perfs}</td></tr>`;
        }).join('');
        content.innerHTML = `<table class="w-full text-left"><thead><tr class="text-[10px] uppercase text-slate-400 border-b"><th class="p-2">Atlet</th><th class="p-2 text-right">Analisis Prestasi</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
}

function exportToExcel() {
    const summaryData = STUDENTS.map(s => {
        let row = { "NAMA ATLET": s.n, "TAHUN": s.t };
        s.events.forEach(ev => { row[`${ACARA_LABELS[ev]} (BEST)`] = records[s.n]?.best?.[ev] || "-"; row[`${ACARA_LABELS[ev]} (GOAL)`] = (GOALS[s.t] || GOALS["TAHUN 4"])[ev]; });
        return row;
    });
    const attendanceData = STUDENTS.map(s => {
        let row = { "NAMA ATLET": s.n };
        SCHEDULE.forEach(day => { row[day.d] = !day.a.some(a => s.events.includes(a)) ? "-" : (records[s.n]?.daily?.[day.d]?.attend ? "HADIR" : "TIDAK"); });
        return row;
    });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryData), "Prestasi");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(attendanceData), "Kehadiran");
    XLSX.writeFile(wb, "Rekod_Olahraga_KeeTee.xlsx");
}

function showDistribution() {
    const s = SCHEDULE[document.getElementById('sessionSelector').value];
    const list = STUDENTS.filter(std => std.events.some(e => s.a.includes(e)));
    const content = document.getElementById('distContent');
    document.getElementById('distModal').classList.remove('hidden');
    content.innerHTML = '';
    s.a.forEach(acaraKey => {
        let s1 = [], s2 = [], sf = [];
        list.forEach(std => {
            let active = s.a.filter(ev => std.events.includes(ev));
            if (std.events.includes(acaraKey)) {
                if (active.length > 1) { if (active[0] === acaraKey) s1.push(std.n); else s2.push(std.n); }
                else sf.push(std.n);
            }
        });
        const formatList = (names) => names.length === 0 ? '<div class="text-slate-300 italic text-[10px]">-</div>' : names.map((n, i) => `<div class="flex items-center gap-2 py-1 border-b border-white/50 last:border-0"><span class="w-4 h-4 flex items-center justify-center bg-white/50 rounded text-[8px] font-black text-blue-800">${i+1}</span><span class="truncate text-[10px]">${n}</span></div>`).join('');
        const box = document.createElement('div');
        box.className = "bg-white rounded-2xl p-5 shadow-sm border-t-4 border-blue-500 flex flex-col gap-3";
        box.innerHTML = `<h4 class="font-black text-blue-900 text-sm uppercase">${ACARA_LABELS[acaraKey]}</h4><div class="space-y-3">
            <div class="bg-blue-50/80 p-3 rounded-xl"><p class="text-[8px] font-black text-blue-600 mb-1 border-b border-blue-100 pb-1 uppercase tracking-tighter">Sesi 1 (2-3pm)</p>${formatList(s1)}</div>
            <div class="bg-indigo-50/80 p-3 rounded-xl"><p class="text-[8px] font-black text-indigo-600 mb-1 border-b border-indigo-100 pb-1 uppercase tracking-tighter">Sesi 2 (3-4pm)</p>${formatList(s2)}</div>
            <div class="bg-slate-100/80 p-3 rounded-xl"><p class="text-[8px] font-black text-slate-500 mb-1 border-b border-slate-200 pb-1 uppercase tracking-tighter">Sesi Penuh (2-4pm)</p>${formatList(sf)}</div></div>`;
        content.appendChild(box);
    });
}
function closeDist() { document.getElementById('distModal').classList.add('hidden'); }
init();
</script>
</body>
</html>
